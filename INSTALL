# Инсталляция

## Инсталляция Web-сервера

TODO: написать в поцессе миграции на новую ферму

## Инталляция обходчика на серверах мониторинга

Обходчиком является программа `./script/observer_snmpwalker.pl` которая
выполняет сбор оперативной информации с сетевого оборудования опрашивая
его по протоколу SNMP.

### Независимая установка окружения

Для независимой установки программы от системы необходимо создать
нового пользователя. Все дальнейшие действия выполняются от его имени.  
Пользователю устанавливается приоритет поиска исполняемых файлов в `$HOME/bin`
в начале очереди (изменения вносим во все профили командных оболочек).

Инсталляция Perl в домашний каталог:

    wget http://www.cpan.org/src/5.0/perl-5.16.2.tar.gz
    tar -xzf perl-5.16.2.tar.gz
    cd perl-5.16.2
    ./Configure -sde -Duseithreads -Doptimize="-O2 -fomit-frame-pointer -pipe" \
        -Duseshrplib -Ui_malloc -Ui_iconv -Uinstallusrbinperl -Dprefix=$HOME
    make
    make test
    make install
    perl --version
    cpan inc::Module::Install

Если в процессе установки модулей возникли ошибки нужно попробовать установить
более свежую версию [perl][1].

### Установка обходчика

Устанавливаем обходчик в корневой пользовательский каталог

    cd
    export CVSROOT=:pserver:anoncvs@cvs.yalta.net.ua/root
    cvs co Observer
    cd Observer
    cp -f Makefile.PL-walker Makefile.PL
    perl Makefile.PL
    make installdeps

В случае возникновения ошибок пробуем установить сбойный модуль из `cpan`
используя команды `force` и `notest`.

Если, при выполнении, возникли ошибки из-за отсутствия модуля, необходимо с
CPAN загрузить недостающие модули perl и повторить операцию.

Работоспособность программы проверяем запуском команды:

    ./script/observer_snmpwalker.pl -v

Справка:

    ./script/observer_snmpwalker.pl -h

### Первоначальная конфигурация

Копируем и открываем в редакторе `observer.conf`.

    cp observer.conf.default observer.conf

Параметры для обязательного изменения приведены ниже. Первый параметр
определяет тип и хост для соединения с базой данных. Два следующих, имя
пользователя и пароль.

    dsn             dbi:mysql:observer;host=observer-db.domain
    user            *****
    password        *****
    area_host somearea-1.domain

Параметр `area_host` должен содержать уникальное имя зоны обслуживания сервера
мониторинга.

Остальные параметры могут изменяться в зависимости от характера нагрузки на
обходчик и оборудования по которому необходимо выполнять сбор информации.

Запускаем обходчик в тестовом режиме (выход по ^C).

    ./script/observer_snmpwalker.pl -f

Проверка работоспособности выполняется из Веб-интерфейса основного сервера
`Observer` путем создания нового устройства в данной зоне обслуживания (area).

Если все успешно, добавляем обходчик в запуск системы.

    TODO: ...

Для дальнейшего обновления конфигурационного файла при обновлении ПО
создаем отпечаток изменений конфигурации командой:

    ./script/update_config.sh init observer.conf

## Обновление версии обходчика

В случае обновления ПО основного сервера (вебсервера) с изменениями, которые
коснулись обходчика или файла конфигурации, необходимо на всех серверах
мониторинга обновить ПО.

Обновление из репозитория до актуальной версии выпоняется из каталога `Observer`:

    cd Observer
    cvs update

Внесение изменений в текущий конфигурационный файл после обновления ПО
вызывается командой:

    ./script/update_config.sh update

Если во время выполнения комманды ошибок не произошло, заменям конфигурационный
файл на обновленный:

    mv -f observer.conf~ observer.conf

Перезапускаем обходчик для вступления изменений в силу.

## Ссылки

[1]: http://www.perl.org/get.html "Загрузка Perl"
